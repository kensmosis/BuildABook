# Introduction

First, if you find this hard to read as a markdown file, run `make readme` and look at gen/README.pdf

Second, in the immortal words of Douglas Adams: Don't Panic.  If this looks complicated, it's really not.  The Makefile is big because I combined 3 types of book builds in one.  In practice, you'd use a smaller makefile for your specific book type.  I did this to avoid having 3 Makefile examples, which I felt would be more confusing.  The scripts are just stuff I developed after doing this several times.  The code provided isn't the bare minimum to make stuff work.  It's the result of a long evolution of tries, and (for me at least) gets things right.  I'm not a script-coder (most of my coding has been in C/C++), so these aren't perfect or elegant.  But I hope they are suitably well-documented to be of use for the purposes of learning and adaptation.

This is a full, working implementation of a command-line book production system as described in my blog post on www.kmhalpern.com.  It also is the what I use for publishing my own books, adapted for illustrative purposes.  The images are random ones from the web (either PD or with suitable CC licenses), and the text was generated using an online "lorem ipsum" random generator.

As mentioned in the blog post, I highly recommend that you copy and adapt this code rather than try to generalize and centralize it to all your books in an effort to avoid code reuse.  I won't reiterate the reasons I provide there (see the post for details), but my experience has shown this to be the least time-consuming and most flexible approach.

Note that this git repo includes the original image files.  I do not recommend including these (or any large files) in the git repo.  However, I included them so the sample build would be complete and self-contained.  In my actual system, I keep the originals in various locations outside the git repo, and any generated or copied files (such as in `img/`) are not managed by git.

Three types of books are included:  a story collection, a poem collection, and a novel.  From laziness, I reuse the same images and some of the same text for each example.

The key difference between novel and collection production is the following.  With the novel, we assemble individual chapter markdown files into a single big markdown file, then run it through pandoc using a book-level template.  With a collection, we use a book level LaTeX file, which loads a list of input `.tex` files.  Each of these individually is generated by running the piece's markdown file through pandoc using an appropriate template.  This allows more flexibility, including the ability to format different pieces differently, put two poems on a page, etc.

# How to run

## Overall commands

`make clean`		Cleans books files but most image files

`make cleanall`		Cleans all imported/generated files

`make cleanebook`	Cleans just the non-image ebook files

`make readme`		Produce PDF version of this file

## Book production commands

Precede the make command with BOOKTYPE=$type, where $type is

`novel`			Produces the novel example

`stories`		Produces the story collection example
	
`poems`			Produces the poetry/flash-fiction collection example

Then you run one of the following:

`make book`		Produces `out/$type.pdf`, the production print interior.

`make ebook`	Produces `out/$type.epub`, the epub version (sans covers).

`make justebook`	Same as `make ebook` but only doesn't rebuild any images.  Good for quick testing of ebook tweaks.

`make draft`	Produces `out/draft.pdf`, a draft version for editing.

`make lookinside`		Produces `out/$type_999-8-7777777-66-1.zip`, the bundle for upload to amazon for the print book's look-inside feature.

`make ecovers`	Produces front and back covers, sized to amazon

`make all`		Everything for that book type

## Special commands to produce individual poems and stories for editing or submission.  

`ITEM=$name [ANON=1] make item`  Generates a standalone pdf of the piece (using the correct poem, flash-fiction, or story) format.  It extracts all the info from the status file.  $name is the entry in the status.txt file.  This excludes the prefix and suffix.I.e., if `story_foo.md` is the file, but `foo` appears in `status.txt`, we would use `foo`.  

The output is print-ready on 8.5 x 11.  The format can be modified as required for submissions.

In this sample setup, the status file is `stories_status.txt`, but in general it would be `status.txt` for a collection.  It must have the `Format` field discussed below for collections.

An optional `ANON=1` can be used as well to produce output without any identifying info (and just "copyrighted" in the header), as needed for some contests, etc. NOTE: this only affects the print output.  Such info may be included as pdf metadata, but usually contests only care about the print output.

`make cleanitems`	Removes all item-related output (for all items, not any specific one).

## Examples

`make cleanall`

`BOOKTYPE=stories make ebook`

`BOOKTYPE=poems make draft`

`BOOKTYPE=novel make book`

`BOOKTYPE=poems make all`

`ITEMTYPE=poem ITEM=poem_happy make item`

`ITEMTYPE=story ITEM=story_blue make item`

`ITEMTYPE=flash ITEM=flash_if make item`

`ANON=1 ITEMTYPE=story ITEM=story_green make item`

# Directories and Files

## General

`README.md`			You're reading it.

`LICENSE.txt`		License info for this, as well as where I got the sample images.

`.gitignore`		I allow images, but you should not.

`Makefile`			Controls the build process.  **You will need to adapt this to the names and locations of your original items, and probably change many of the image generation parameters.**

`status.txt`		The table of chapters, stories, etc.  This tells us how to build the book(s). **This is very specific to your books.  You will need to replace the entries with your own, and may wish to adapt/add fields as well.**

`src/`				Contains all chapter, story, and poem source files, as well as some backmatter source files (biography, acknowledgments, etc). **You'll need to replace the entire contents with your own, of course!**

`originalloc1/`		Proxy for the external source locations of the author's 1st book.  The blurb and cover-image files for that book are imported from there.  Normally this would NOT be part of the present git repo.

`originalloc2/`		Proxy for the external source locations of the author's 2nd book.  The blurb and cover-image files for that book are imported from there.  Normally this would NOT be part of the present git repo.

`originalloc3/`		Proxy for the external source locations of the original cover art and frontispiece image for the current book.  Normally this would NOT be part of the present git repo.

`ReadStatus.py`		Library of routines for parsing `status.txt` file.  **You won't need to change this.**

`Status.py`			Script to give general info on word-counts.  **You won't need to change this.**

## Print Book production

`AssembleBook.py`		The script which assembled the chapters into a single .md file as the precursor to book and draft generation. **This generally won't require much adaptation.  You can tweak it to add chapter subtitles, etc.**

`KenLatexTemplate.book.pandoc`	Controls the output print book format.  **You will need to adapt this quite heavily.**

`KenLatexTemplate.draft.pandoc`	Controls the draft print format.  **This will need at least minor adaptation.  Other versions (for various manuscript or submission purposes) may be needed as well.**

## ebook production

`KenEpubStyles.css`	Controls chapter title format and image layout in ebook. **You generally won't want to change this.**

`EbookBuild.py`		The analog of AssembleBook.py for the epub version. However, in terms of specificity this is more akin to KenLatexTemplate.book.pandoc than AssembleBook.py.  **This needs heavy adaptation to your book, since it controls the layout of the ebook.**

`KenEpubTemplate.pandoc`	Despite its name, this is very generic.  It basically replaces pandoc's auto-gen'ed title page with the title page image we extract from the print version.  **You won't need to change this.**

## Generated directories (not under version control)

gen/			Most intermediate files, including some images.
out/			Final output files
img/			Imported original image files, and most generated ones.

## poem/story/flash-fiction collection and item production

`KenCompilationBook.tex`	The master LaTeX file for the output print book of a compilation.  The main text is loaded from a generated file called `gen/inputlist.tex`. **This is the counterpart of `KenLatexTemplate.book.pandoc` for the novel, and requires lots of adaptation.**

`KenCompilationDraft.tex`	The master LaTeX file for the draft print book of a compilation.  The main text is loaded from a generated file called `gen/inputlist.tex`. **This is the counterpart of `KenLatexTemplate.draft.pandoc` for the novel, and may require a little adaptation.**

`GenInputs.py`		Produces a list of the input items for a compilation. **This generally won't require adaptation, but if extra flexibility is needed for the formatting of certain poems, it may.**

`ConvertItemsToTex.py`	Converts the individual items from markdown to LaTeX.  Since this relies on reading `status.txt`, we run the `pandoc` command here, rather than in the `Makefile` itself (since needs knowledge of the correct list of files). **This should not require any modification.**

`GetItemInfo.py`	Utility script which extracts type of a piece from status.txt for use in Makefile.  **This should not require any modification.**

`Makefile.indiv`	Used as part of single-item production chain (for producing pdfs of individual pieces).  **This should not require any modification.**

`RunItemMake.py`	Used as part of single-item production chain (for producing pdfs of individual pieces).  **This should not require any modification.**

# Necessary externals

The following programs must be installed.  I've listed in () the version I happened to use at the time of writing.  However, the system shouldn't be highly-dependent on the specific versions.

python 3  	(3.8.8)

pandoc	  	(2.1.3)

pdflatex	(3.14159265-2.6-1.40.20)	[part of texlive]

pdfseparate	(20.08.0)			[part of poppler utilities]

convert		(6.9.12-17)			[part of ImageMagick]

zip		(3.0)

make		(4.3)				[gnu make]

git		(2.29.3)			[not strictly necessary]

I also used sigil (1.5.1) for the minor TOC fix mentioned. 

# Note on images

Many of the image conversions in the Makefile are simple.  Either copies or just format changes.  In reality, you may need to tweak your images.  The Makefile is the place to put all transformations (crop, resize, brightness changes, etc).  The goal is to make the entire production pipeline reproducible from the original cover art.  This may take some manual tweaking at first (I use eog and imagemagick's identify and convert) as useful tools for this.  Do NOT simply use Gimp to get the result you want and store that file.  Add the CLI generation chain to the Makefile.  Trust me.  You'll thank me later.  

# Writing chapters, stories, poems, and flash-fiction

## General writing rules

* All writing should be done in markdown (.md) files and placed in src/
* Hard linebreaks are ignored.  To produce a linebreak, use a blank line.  I.e., if you want a single-spaced bunch of lines, double space them in the markdown.
* Do not use top level headers (`#`), since these are added automatically by the scripts.
* Use `*foo*` for italics and `**foo**` for bold face.  These cover 99% of my formatting needs.  Except for certain poetry, the vast majority of your .md files should be plain ascii.
* You can use other markdown (lists, verbatim, etc)
* Use `""` (ascii double-quotes) for double-quotes and `''` (ascii single-quotes) for single-quotes.  They automatically become smart.  Use backticks around something to keep it verbatim
* Vertical and horizontal white space is not controlled visually.  100 spaces is one space and 100 blank lines is 1 blank line.  
* To add explicit white space (ex. indent lines in a precise pattern for poetry), use &nbsp; and add as many as needed.
* To add explicit a blank line, use the appropriate header-level symbol by book type below.
* Whether paragraphs are indented or not, and whether they have a blank line between them depends on the mode (novel or collection, and story/poem/flash-fiction in the latter).
* Heading levels 2+ (i.e. `##`, `###`, `####`, etc) have specific meanings based on whether a novel or collection.
* You can use html and url's (`<a href=...>` tags, etc)
* See the pandoc markdown documentation for the other things you can use
* If using links, make sure they are pulled into the epub (so it can stand on its own).

## Novels

* For novels, paragraphs are indented (except the 1st in a chapter) and there is no blank line between paragraphs.
* `# title`		Automatically added by AssembleBook.py.  Start a new chapter with the title specified.
* `##`			Use as needed.  Denotes a section break within a chapter.  Inserts an ornamental flourish (or `*****` in the ebook)
* `### file`	Automatically added by AssembleBook.py.   This inserts a filename at any section break (even invisible ones).  It is ignored in the book output, but displayed in draft output to aid editing.
* `#### foo`	Usually automatically added by AssembleBook.py, but can be manual too.  Specifies a subtitle for a chapter.  Ex. if each chapter has a date and location subtitle.  If being done for all chapters, it should be performed by AssembleBook.py using info provided by status.txt.  However, if one-off, it can be performed by manually adding such a line.  It should be preceded and followed by blank lines.  This also may be used to add a bold centered item.
* `##### foo`	Manual. Inserts a bold-faced large centered item.  Ex. The End.

## Collections

* For collections, the indentation and line spacing style vary piece by piece, and depend on whether a given piece is listed as flash-fiction ('F'), a poem ('P'), or a story ('C') in the "Format" field of the status file.  If not specified, 'F' is the default.
* For poems, there is no indent, and no space between pars.
* For flash-fiction, there is no indent, but a blank line between pars.
* For stories, there is an indent, but no space bwteen pars.
* Note that linebreaks are ignored in ALL 3 modes.  Formatting a poem visually as you would like to see it is not good enough.  The lines must have blank lines between them.  
* A good way to think of poems is that a double-spaced line in markdown corresponds to a single-spaced line in the output, and a `###` corresponds to a stanza break.  The need for the latter arises because we're pretending each visual line actually is a par from the standpoint of markdown.
* `# foo`		This is ignored.  It can be used to insert a comment or some info in the piece.  Ex. to include the actual title, so it is incorporated in the file rather than just status.txt.  Actual piece titles are inserted automatically by the scripts. We do this so that multiple pieces can be placed on the same page (which chapter-level headers don't easily allow).
* `##`			Manual. Force a page-break if the styling requires it.
* `###`			Manual. Force a stanza break (blank line).  Should mostly appear in poems.
* `####`		Manual. Add a bold centered line (with blank lines before and after).  Ex. a subsection header in a story or poem.
* `#####`		Not used.  Can be employed for customization as needed.

# Adaptation to your own book

## General

* .gitignore:
	- You probably will want to add png, jpg, and any other relevant image types to this so that you don't get bugged to add images to git (which you should NOT do).
	- You should start your own repo that is empty.  Then copy the relevant files from this sample project.  Adapt them, and then add them (sans any image files) to your git repo.
	
* originalloc*/:
	- Obviously, these don't apply to your project.  You will reference your own external locations, so these may be removed along with their contents.

* Makefile:
	- Remove the irrelevant parts (collection if producing a novel or vice-versa if producing a collection). 
	- Adjust the title, author, and print-isbn info.
	- Adjust the advert book list (changing names and adding/removing as needed).
	- Set the correct locations for original source materials (advert blurbs and cover-images for the prior books, the cover art for the present book, and any interior art).
	- Once everything else is in place and working, check the correct PDF page numbers for the halftitle, copyright, title pages and set those.
	- Manually determine any image adjustments (crop, scaling, color-adjustments, etc) which need to be applied to the `front_cover.jpg`, `back_cover.jpg`.
	- Ditto for interior images, bw and small versions of cover art from prior books, etc.  I.e., make sure all images look good at the correct sizes (and in bw).

* src/:
	- Obviously, this should contain your own files.  Each should be written in markdown according to the specs described above.
	- In particular, make sure the `about.md` and `ack.md` entries are correct.
	- In particular, adjust thankyou.html to include your info and read as you would like.

* ReadStatus.py, Status.py:   Don't touch these.

* KenEpubTemplate.pandoc:   Don't touch this.

* GetItemInfo.py:  Don't touch this.

## Novel

* status.txt:
	- This is best adapted from novel_status.txt.
	- Add your own custom fields if needed.  Note that they need to be fully populated (i.e. no blank entries).  Their interpretation will be performed in AssembleBook.py and EbookBuild.py.
	- If you are using a common prefix for all your chapters (ex Chapfoo.md is your naming convention), adjust @PRE
	- Adjust the @BOOK field.
	- Add entries for each file.  If the file starts a new chapter (the 1st listed must), Type is 'C'.  If it starts a new section (visible) within a chapter, type is 'S', and if it just adds (invisible) to the previous entry use 'I' (i.e. for organizational splitting of files rather than visual).

* AssembleBook.py:
	- If you want to change the chapter titles (ex. from "Chapter %d" to the title in the status.txt file), edit that entry.
	- If you want chapter subtitles, add a `####`-production line which generates the correct subtitle from info from the status.txt file.
	- The relevant info can be accessed via commands in `ReadStatus.py`.
	
* KenLatexTemplate.book.pandoc:
	- Change the author, print/ebook isbn's, lccn, press, author, and artist.
	- Adjust title page layout if desired.
	- Adjust copyright page layout if desired.
	- Tailor the adverts to your work.
	- Rearrange and add/subtract front/back matter (ex. adverts, acks, etc) as desired. Make sure comes out correct recto (odd pages) vs verso (even pages), and make sure body of text starts on recto.
	- Add any frontispiece or other images.  Make sure the Makefile generates them if used.  Ditto for any advert images and blurbs.
	- Adjust the copyright-page disclaimer.  No, you probably don't want it as is.
	- Adjust the "The End" flourish to your taste.
	- Make any other formatting changes you desire (booksize, margins, header-footer layout, chapter-styling, etc).
	- Add/subtract blank pages at end to make pagecount a multiple of 4
	
* KenLatexTemplate.draft.pandoc:
	- Change the author and title.
	- Adjust margins and line spacing to your taste.

* KenEpubStyles.css:
	- If you are unhappy with the styling of the ebook you can change this, but you generally won't want to.
	
* EbookBuild.py:
	- If desired, adjust the section flourishes (the `##` entries in the markdown). 
	- If desired, adjust the "The End" flourish.
	- Adjust/customize the layout of frontmatter and backmatter as desired. This is in the main() routine at the bottom, and appear in the form of Accum* commands.

## Collection

* status.txt:
	- This is best adapted from stories_status.txt.
	- Add your own custom fields if needed.  Note that they need to be fully populated (i.e. no blank entries).  Their interpretation will be performed in AssembleBook.py and EbookBuild.py.
	- The last field should be Title.  If it is provided, then this is used as the title of the piece (preserving whatever capitalization is used.  If not, then the 1st field (name sans prefix or suffix) will be used, but with the 1st letter capitalized if it isn't already.
	- If you are using a common prefix for all your chapters (ex Chapfoo.md is your naming convention), adjust @PRE
	- Adjust the @BOOK field.
	- Add entries for each file.  Type is 'C' for all.  Format is a :-delimited string.  Include 'P' for poem, 'F' for flash-fiction, 'C' for story ('F' is the default if none specified).  Include 'S' for standalone or 'D1' or 'D2' for the top/bottom half of a 2-entry page.  Note that a D1 entry always must be followed by a D2 entry.  Every line must have S, D1, or D2.  Use L:n.m to adjust the linespread just for that piece.  This is useful if you need to squeeze a piece onto a page slightly.  Small changes are not visibly noticeable.  Default linespread is 1.35.  If the file starts a new chapter (the 1st listed must), Type is 'C'.  If it starts a new section (visible) within a chapter, type is 'S', and if it just adds (invisible) to the previous entry use 'I' (i.e. for organizational splitting of files rather than visual).  You can leave the Title field blank if the display title exactly matches the 1st field (the filename sans prefix and suffix).

* AssembleBook.py:
	- You generally won't need to change this.
	
* KenCollectionBook.tex:
	- Change the author, print/ebook isbn's, lccn, press, author, and artist.
	- Adjust title page layout if desired. In particular add a subtitle if desired.
	- Adjust copyright page layout if desired.
	- Tailor the adverts to your work.
	- Rearrange and add/subtract front/back matter (ex. adverts, acks, etc) as desired. Make sure comes out correct recto (odd pages) vs verso (even pages), and make sure body of text starts on recto.
	- Add any frontispiece or other images.  Make sure the Makefile generates them if used.  Ditto for any advert images and blurbs.
	- Adjust the copyright-page disclaimer.  No, you probably don't want it as is.
	- Tailor the "Call to action page" to your taste, or eliminate it (and the blank page following it).
	- Make any other formatting changes you desire (booksize, margins, header-footer layout, chapter-styling, etc).
	- Add/subtract blank pages at end to make pagecount a multiple of 4
	
* KenCollectionDraft.tex:
	- Change the author and title.
	- Adjust margins and line spacing to your taste.

* KenEpubStyles.css:
	- If you are unhappy with the styling of the ebook you can change this, but you generally won't want to.
	
* EbookBuild.py:
	- Adjust/customize the layout of frontmatter and backmatter as desired. This is in the main() routine at the bottom, and appear in the form of Accum* commands.

